<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
  <script src="../web_modules/d3/build/d3.js"></script>
  <style>
    body {
      width: 800px;
      margin: 25px auto;
      font-family: "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
    }

    rect {
      fill: steelblue;
      fill-opacity: 0.8;
    }

    rect:hover {
      fill-opacity: 1;
    }

    .axis {
      font-size: smaller;
    }
  </style>
</head>

<body>
  <h1>Student's First Bar Chart</h1>

  <script>

    const margin = { top: 40, bottom: 10, left: 120, right: 20 };
    const width = 800 - margin.left - margin.right;
    const height = 600 - margin.top - margin.bottom;

    // Creates sources <svg> element
    const svg = d3.select('body').append('svg')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height + margin.top + margin.bottom);

    // Group used to enforce margin
    const g = svg.append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`);

    // Global variable for all data
    var data;

    const bar_height = 50;

    /////////////////////////
    // TODO create an x and y scale and axis
    // x a linear scale with range: [0, width] and domain from 0 max temperature
    // y a band ordinal scale range: [0, height] and domain the different cities


    // prepare scaling functions, domain will be set when we have data
    const xscale = d3.scaleLinear().range([0, width]); 
    const yscale = d3.scaleBand().range([0, height]);

    const xaxis = d3.axisTop().scale(xscale); // axis with labels below line
    const yaxis = d3.axisLeft().scale(yscale); // axis with labels left of line

    const xaxis_container = g.append('g').classed('x.axis', true); 
    const yaxis_container = g.append('g').classed('y.axis', true);
    

    d3.json('weather.json')
      .then((json) => {
        data = json;
        update(data);
        setTimeout(() => update(data), 3000); //test second update
      })
      .catch((error) => {
        console.error('Error loading the data');
      });

    // You might find the callback notation (for D3 < v5.0) for some examples:
    // ```
    // d3.json('weather.json', (error, json) => {
    //  if(error) {
    //    console.error('Error loading the data');
    //  } else {
    //    data = json;
    //    update(data);
    //  }
    // });
    // ```

    function update(new_data) {
      console.log('update')
      // Render the chart with new data

      //with the data, we can set the domain now:
      xscale.domain([0, d3.max(data.map(d => d.temperature))]);
      yscale.domain(data.map(d => d.location.city));
      
      //update axis:
      xaxis_container.call(xaxis);
      yaxis_container.call(yaxis);



      // DATA JOIN
      const rect = g.selectAll('rect').data(new_data);

      // ENTER
      // new elements
      const rect_enter = rect.enter().append('rect')
        .attr('x', 0)
      rect_enter.append('title');

      // ENTER + UPDATE
      // both old and new elements
      rect.merge(rect_enter)
        .attr('height', bar_height)
        .attr('width', (d) => xscale(d.temperature))
        .attr('y', (d, i) => i * (bar_height + 5));

      rect.merge(rect_enter).select('title').text((d) => d.location.city);

      // EXIT
      // elements that aren't associated with data
      rect.exit().remove();

    }

  </script>
</body>

</html>
